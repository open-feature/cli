/**
 * AUTOMATICALLY GENERATED BY OPENFEATURE CLI. DO NOT MODIFY MANUALLY.
 *
 * This file contains generated typesafe Angular services and directives
 * for feature flags defined in your OpenFeature flag manifest.
 *
 * @openfeature/angular-sdk 1.1.0 or newer is required as a peer dependency.
 *
 * @see https://openfeature.dev
 */

import {
  ChangeDetectorRef,
  Directive,
  inject,
  Injectable,
  Input,
  OnChanges,
  TemplateRef,
  ViewContainerRef,
} from '@angular/core';
import {
  AngularFlagEvaluationOptions,
  EvaluationDetails,
  FeatureFlagDirective,
  FeatureFlagDirectiveContext,
  FeatureFlagService,
  JsonValue,
} from '@openfeature/angular-sdk';
import { Observable } from 'rxjs';

// ============================================================================
// FLAG KEYS
// ============================================================================

/**
 * Constant object containing all feature flag keys.
 * Use these constants to reference flag keys in a type-safe manner.
 */
export const FlagKeys = {
{{- range .Flagset.Flags }}
  /**
   * Flag key for {{ if .Description }}{{ .Description }}{{ else }}this flag{{ end }}.
   * - Type: `{{ .Type | OpenFeatureType }}`
   * - Default: `{{ if eq (.Type | OpenFeatureType) "object"}}{{ .DefaultValue | ToJSONString }}{{ else }}{{ .DefaultValue }}{{ end }}`
   */
  {{ .Key | ToScreamingSnake }}: {{ .Key | Quote }},
{{- end }}
} as const;

/**
 * Type representing all available flag keys.
 */
export type FlagKey = (typeof FlagKeys)[keyof typeof FlagKeys];

// ============================================================================
// GENERATED FEATURE FLAG SERVICE
// ============================================================================

/**
 * Generated typesafe feature flag service.
 * Provides strongly-typed methods for each feature flag defined in the manifest.
 *
 * @example
 * ```typescript
 * @Component({
 *   selector: 'app-my-component',
 *   template: `
 *     <div *ngIf="(myFlag$ | async)?.value">Feature enabled!</div>
 *   `
 * })
 * export class MyComponent {
 *   private flags = inject(GeneratedFeatureFlagService);
 *   myFlag$ = this.flags.getMyFlagDetails();
 * }
 * ```
 */
@Injectable({ providedIn: 'root' })
export class GeneratedFeatureFlagService {
  private readonly flagService = inject(FeatureFlagService);

{{ range .Flagset.Flags }}
  /**
   * Get evaluation details for the `{{ .Key }}` flag.
   *
   * {{ if .Description }}{{ .Description }}{{ else }}Feature flag.{{ end }}
   *
   * **Details:**
   * - Flag key: `{{ .Key }}`
   * - Type: `{{ if eq (.Type | OpenFeatureType) "object" }}JsonValue{{ else }}{{ .Type | OpenFeatureType }}{{ end }}`
   * - Default value: `{{ if eq (.Type | OpenFeatureType) "object"}}{{ .DefaultValue | ToJSONString }}{{ else }}{{ .DefaultValue }}{{ end }}`
   *
   * @param domain - Optional domain for flag evaluation (scopes the flag to a specific provider).
   * @param options - Optional configuration for the flag evaluation.
   * @returns An Observable that emits EvaluationDetails whenever the flag value changes.
   */
  get{{ .Key | ToPascal }}Details(
    domain?: string,
    options?: AngularFlagEvaluationOptions
  ): Observable<EvaluationDetails<{{ if eq (.Type | OpenFeatureType) "object" }}JsonValue{{ else }}{{ .Type | OpenFeatureType }}{{ end }}>> {
    return this.flagService.{{ .Type | SdkServiceMethod }}(
      {{ .Key | Quote }},
      {{ if eq (.Type | OpenFeatureType) "object"}}{{ .DefaultValue | ToJSONString }}{{ else }}{{ .DefaultValue | QuoteString }}{{ end }},
      domain,
      {
        updateOnConfigurationChanged: options?.updateOnConfigurationChanged ?? true,
        updateOnContextChanged: options?.updateOnContextChanged ?? true,
      }
    );
  }
{{ end }}
}

// ============================================================================
// GENERATED STRUCTURAL DIRECTIVES
// ============================================================================

{{ range .Flagset.Flags }}
{{ $type := .Type | OpenFeatureType }}
/**
 * Structural directive for the `{{ .Key }}` feature flag.
 *
 * {{- if .Description }}{{ .Description }}{{- end }}
 *
 * This directive extends `FeatureFlagDirective` from @openfeature/angular-sdk
 * with a pre-configured flag key and default value.
 *
 * **Details:**
 * - Flag key: `{{ .Key }}`
 * - Type: `{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}`
 * - Default value: `{{ if eq $type "object"}}{{ .DefaultValue | ToJSONString }}{{ else }}{{ .DefaultValue }}{{ end }}`
 *
 *
 * @example
 * Explicit `ng-template` (no `*`), bind inputs directly
 * ```html
 * <ng-template {{ .Key | ToCamel }}
 *   [{{ .Key | ToCamel }}Default]="defaultValue"
 *   {{ if ne $type "boolean" }}[{{ .Key | ToCamel }}Value]="expectedValue"
 *   {{ end }}[{{ .Key | ToCamel }}Else]="elseTemplate"
 *   [{{ .Key | ToCamel }}Initializing]="initTemplate"
 *   [{{ .Key | ToCamel }}Reconciling]="reconcilingTemplate">
 *   <div>Content shown when flag is {{ if eq $type "boolean" }}enabled{{ else }}matched{{ end }}.</div>
 * </ng-template>
 * <ng-template #elseTemplate>
 *   Content shown when flag is {{ if eq $type "boolean" }}disabled{{ else }}not matched{{ end }}.
 * </ng-template>
 * ```
 *
 * @example
 * Microsyntax `*` form, start with `let`
 * ```html
 * <div *{{ .Key | ToCamel }}="let v; {{ if ne $type "boolean" }}value: expectedValue; {{ end }}else: elseTemplate; initializing: initTemplate; reconciling: reconcilingTemplate">
 *   Content shown when flag is {{ if eq $type "boolean" }}enabled{{ else }}matched{{ end }}.
 * </div>
 * ```
 *
 * @example
 * Simple `*` usage (no else/initializing/reconciling)
 * ```html
 * <div *{{ .Key | ToCamel }}="let v">
 *   Content shown when flag is {{ if eq $type "boolean" }}enabled{{ else }}matched{{ end }}.
 * </div>
 * ```
 *
 * @remarks
 * Note: Angular's microsyntax parser requires the first segment to be a primary
 * expression or a `let` declaration. Because the flag key is preconfigured, start with
 * `let v` or `let details = evaluationDetails` (or `let _` if you do not need the value)
 * before any `else`/`initializing`/`reconciling`/`default` segments.
 * This is an Angular microsyntax parsing constraint, not a directive limitation.
 * `*{{ .Key | ToCamel }}="else elseTemplate"` will not parse because `else` is a
 * secondary segment. If you do not need the value, use `let _`, or use the
 * explicit `ng-template` form above.
 */
@Directive({
  selector: '[{{ .Key | ToCamel }}]',
  standalone: true,
})
export class {{ .Key | ToPascal }}FeatureFlagDirective extends FeatureFlagDirective<{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}> implements OnChanges {
  override _changeDetectorRef = inject(ChangeDetectorRef);
  override _viewContainerRef = inject(ViewContainerRef);
  override _thenTemplateRef = inject<TemplateRef<FeatureFlagDirectiveContext<{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}>>>(TemplateRef);

{{- if ne $type "boolean" }}

  /**
   * The expected value of this {{ $type }} feature flag, for which the `then` template should be rendered.
   */
  @Input({ required: false }) {{ .Key | ToCamel }}Value?: {{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }};
{{- end }}

  constructor() {
    super();

    this._featureFlagKey = {{ .Key | ToCamel | QuoteString }};
    this._featureFlagDefault = {{ if eq $type "object"}}{{ .DefaultValue | ToJSONString }}{{ else }}{{ .DefaultValue | QuoteString }}{{ end }};
{{ if eq $type "boolean" }}
    this._featureFlagValue = true;
{{ end }}
  }

{{- if ne $type "boolean" }}

  override ngOnChanges() {
    super.ngOnChanges();

    this._featureFlagValue = this.{{ .Key | ToCamel }}Value;
  }
{{- end }}

  /**
   * The domain of the {{ $type }} feature flag.
   */
  @Input({ required: false })
  set {{ .Key | ToCamel }}Domain(domain: string | undefined) {
    super.featureFlagDomain = domain;
  }

  /**
   * Update the component if the provider emits a ConfigurationChanged event.
   * Set to false to prevent components from re-rendering when flag value changes
   * are received by the associated provider.
   * Defaults to true.
   */
  @Input({ required: false })
  set {{ .Key | ToCamel }}UpdateOnConfigurationChanged(enabled: boolean | undefined) {
    this._updateOnConfigurationChanged = enabled ?? true;
  }

  /**
   * Update the component when the OpenFeature context changes.
   * Set to false to prevent components from re-rendering when attributes which
   * may be factors in flag evaluation change.
   * Defaults to true.
   */
  @Input({ required: false })
  set {{ .Key | ToCamel }}UpdateOnContextChanged(enabled: boolean | undefined) {
    this._updateOnContextChanged = enabled ?? true;
  }

  /**
   * Template to be displayed when the feature flag {{ if eq $type "boolean" }}is false{{ else }}does not match value{{ end }}.
   */
  @Input()
  set {{ .Key | ToCamel }}Else(tpl: TemplateRef<FeatureFlagDirectiveContext<{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}>>) {
    this._elseTemplateRef = tpl;
  }

  /**
   * Template to be displayed when the provider is not ready.
   */
  @Input()
  set {{ .Key | ToCamel }}Initializing(tpl: TemplateRef<FeatureFlagDirectiveContext<{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}>>) {
    this._initializingTemplateRef = tpl;
  }

  /**
   * Template to be displayed when the provider is reconciling.
   */
  @Input()
  set {{ .Key | ToCamel }}Reconciling(tpl: TemplateRef<FeatureFlagDirectiveContext<{{ if eq $type "object" }}JsonValue{{ else }}{{ $type }}{{ end }}>>) {
    this._reconcilingTemplateRef = tpl;
  }
}

{{ end }}

// ============================================================================
// EXPORTS
// ============================================================================

/**
 * Array of all generated feature flag directives.
 * Import this in your module or standalone component to use the directives.
 *
 * @example
 * ```typescript
 * @Component({
 *   standalone: true,
 *   imports: [GeneratedFeatureFlagDirectives],
 *   template: `<div *myFeatureFlag>...</div>`
 * })
 * export class MyComponent {}
 * ```
 */
export const GeneratedFeatureFlagDirectives = [
{{- range .Flagset.Flags }}
  {{ .Key | ToPascal }}FeatureFlagDirective,
{{- end }}
] as const;
